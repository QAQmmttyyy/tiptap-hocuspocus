# æ•°æ®æ¨¡å‹ - åä½œå…³ç³»è®¾è®¡è¯¦è§£

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡Šå®æ—¶åä½œæ–‡æ¡£ç³»ç»Ÿä¸­çš„åä½œå…³ç³»è®¾è®¡ï¼ŒåŒ…æ‹¬æ•°æ®æ¨¡å‹ã€ä¸šåŠ¡é€»è¾‘å’Œå®é™…åº”ç”¨åœºæ™¯ã€‚

## ğŸ—ï¸ æ•°æ®æ¨¡å‹ç»“æ„

### æ ¸å¿ƒæ¨¡å‹å…³ç³»å›¾

```mermaid
erDiagram
    User ||--o{ Document : "åˆ›å»º (author)"
    User ||--o{ DocumentCollaborator : "å‚ä¸åä½œ"
    Document ||--o{ DocumentCollaborator : "åä½œè€…åˆ—è¡¨"
    
    User {
        string id PK
        string name
        string email
        string avatar
        datetime createdAt
        datetime updatedAt
    }
    
    Document {
        string id PK
        string title
        string description
        bytes content
        boolean isPublic
        int version
        string authorId FK
        datetime createdAt
        datetime updatedAt
    }
    
    DocumentCollaborator {
        string id PK
        string userId FK
        string documentId FK
        enum role
        datetime createdAt
    }
```

### å…³ç³»è¯´æ˜

| å…³ç³» | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `User.documents` | ä¸€å¯¹å¤š | ç”¨æˆ·åˆ›å»ºçš„æ–‡æ¡£ |
| `User.collaborations` | ä¸€å¯¹å¤š | ç”¨æˆ·å‚ä¸çš„åä½œå…³ç³» |
| `Document.author` | å¤šå¯¹ä¸€ | æ–‡æ¡£çš„åˆ›å»ºè€… |
| `Document.collaborators` | ä¸€å¯¹å¤š | æ–‡æ¡£çš„åä½œè€…åˆ—è¡¨ |

## ğŸ¤ åä½œå…³ç³»æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¸¤ç§ä¸åŒçš„æ–‡æ¡£å…³è”

```typescript
model User {
  // å…³ç³»1ï¼šæˆ‘åˆ›å»ºçš„æ–‡æ¡£ (æ‰€æœ‰æƒå…³ç³»)
  documents      Document[]              
  
  // å…³ç³»2ï¼šæˆ‘å‚ä¸çš„åä½œå…³ç³» (å‚ä¸å…³ç³»)  
  collaborations DocumentCollaborator[]  
}
```

**å…³é”®åŒºåˆ«ï¼š**
- **`documents`**ï¼šæˆ‘æ‹¥æœ‰çš„æ–‡æ¡£ï¼ˆåˆ›å»ºè€…èº«ä»½ï¼‰
- **`collaborations`**ï¼šæˆ‘èƒ½è®¿é—®çš„æ‰€æœ‰æ–‡æ¡£ï¼ˆåŒ…æ‹¬æˆ‘åˆ›å»ºçš„å’Œåˆ«äººé‚€è¯·æˆ‘çš„ï¼‰

### 2. ä¸­é—´è¡¨çš„å¿…è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦ `DocumentCollaborator` ä¸­é—´è¡¨ï¼Ÿ**

å› ä¸ºç”¨æˆ·å’Œæ–‡æ¡£ä¹‹é—´æ˜¯ **å¤šå¯¹å¤šå…³ç³»** + **è§’è‰²æƒé™**ï¼š

```sql
-- âŒ ç®€å•å…³è”ï¼ˆæ— æ³•å­˜å‚¨è§’è‰²ä¿¡æ¯ï¼‰
User â†â†’ Document  

-- âœ… é€šè¿‡ä¸­é—´è¡¨ï¼ˆå¯ä»¥å­˜å‚¨è§’è‰²å’Œæƒé™ï¼‰
User â†â†’ DocumentCollaborator â†â†’ Document
         â†‘ åŒ…å«è§’è‰²ä¿¡æ¯ (OWNER/EDITOR/VIEWER)
```

### 3. è§’è‰²æƒé™ä½“ç³»

```typescript
enum CollaboratorRole {
  OWNER    // æ‹¥æœ‰è€…ï¼šå®Œå…¨æ§åˆ¶æƒé™
  EDITOR   // ç¼–è¾‘è€…ï¼šç¼–è¾‘æ–‡æ¡£å†…å®¹  
  VIEWER   // æŸ¥çœ‹è€…ï¼šåªè¯»æƒé™
}
```

| è§’è‰² | æƒé™è¯´æ˜ |
|------|----------|
| **OWNER** | åˆ é™¤æ–‡æ¡£ã€ç®¡ç†åä½œè€…ã€ç¼–è¾‘å†…å®¹ã€æ›´æ”¹æ–‡æ¡£è®¾ç½® |
| **EDITOR** | ç¼–è¾‘æ–‡æ¡£å†…å®¹ã€æŸ¥çœ‹æ–‡æ¡£ã€è¯„è®º |
| **VIEWER** | æŸ¥çœ‹æ–‡æ¡£å†…å®¹ã€è¯„è®ºï¼ˆåªè¯»æ¨¡å¼ï¼‰ |

## ğŸ“Š å®é™…æ•°æ®ç¤ºä¾‹

### ç§å­æ•°æ®ä¸­çš„åä½œå…³ç³»

æ ¹æ®æˆ‘ä»¬çš„ç§å­æ•°æ®ï¼Œä»¥ä¸‹æ˜¯å®é™…çš„åä½œå…³ç³»ï¼š

```
ğŸ‘¤ å¼ ä¸‰ (temp_user_001)
â”œâ”€â”€ åˆ›å»ºçš„æ–‡æ¡£ (documents):
â”‚   â”œâ”€â”€ ğŸ“„ æ¬¢è¿ä½¿ç”¨åä½œç¼–è¾‘å™¨ (doc_welcome)
â”‚   â””â”€â”€ ğŸ“„ é¡¹ç›®å¼€å‘è®¡åˆ’ (doc_project_plan)
â””â”€â”€ å‚ä¸çš„åä½œ (collaborations):
    â”œâ”€â”€ ğŸ¤ æ¬¢è¿æ–‡æ¡£ - OWNER
    â””â”€â”€ ğŸ¤ é¡¹ç›®è®¡åˆ’ - OWNER

ğŸ‘¤ æå›› (temp_user_002)  
â”œâ”€â”€ åˆ›å»ºçš„æ–‡æ¡£ (documents):
â”‚   â””â”€â”€ ğŸ“„ å›¢é˜Ÿä¼šè®®çºªè¦ (doc_meeting_notes)
â””â”€â”€ å‚ä¸çš„åä½œ (collaborations):
    â”œâ”€â”€ ğŸ¤ ä¼šè®®çºªè¦ - OWNER
    â””â”€â”€ ğŸ¤ é¡¹ç›®è®¡åˆ’ - EDITOR  â† è¢«å¼ ä¸‰é‚€è¯·

ğŸ‘¤ ç‹äº” (temp_user_003)
â”œâ”€â”€ åˆ›å»ºçš„æ–‡æ¡£ (documents):
â”‚   â””â”€â”€ ğŸ“„ API æ¥å£æ–‡æ¡£ (doc_api_docs)
â””â”€â”€ å‚ä¸çš„åä½œ (collaborations):
    â”œâ”€â”€ ğŸ¤ API æ–‡æ¡£ - OWNER
    â””â”€â”€ ğŸ¤ æ¬¢è¿æ–‡æ¡£ - VIEWER  â† è¢«å¼ ä¸‰é‚€è¯·
```

### å…·ä½“åä½œåœºæ™¯åˆ†æ

**ğŸ“„ "é¡¹ç›®å¼€å‘è®¡åˆ’" æ–‡æ¡£çš„åä½œæƒ…å†µï¼š**

```typescript
{
  title: "é¡¹ç›®å¼€å‘è®¡åˆ’",
  author: "å¼ ä¸‰",
  collaborators: [
    { user: "å¼ ä¸‰", role: "OWNER" },    // åˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºæ‹¥æœ‰è€…
    { user: "æå››", role: "EDITOR" }    // è¢«é‚€è¯·çš„ç¼–è¾‘è€…
  ]
}
```

**æƒé™ç»“æœï¼š**
- âœ… å¼ ä¸‰ï¼šå¯ä»¥åˆ é™¤æ–‡æ¡£ã€é‚€è¯·/ç§»é™¤åä½œè€…ã€ç¼–è¾‘å†…å®¹
- âœ… æå››ï¼šå¯ä»¥ç¼–è¾‘æ–‡æ¡£å†…å®¹ã€æŸ¥çœ‹æ–‡æ¡£
- âŒ ç‹äº”ï¼šæ— æ³•è®¿é—®ï¼ˆä¸åœ¨åä½œè€…åˆ—è¡¨ä¸­ï¼‰

## ğŸ”§ ä¸šåŠ¡é€»è¾‘å®ç°

### 1. åˆ›å»ºæ–‡æ¡£æ—¶çš„åä½œå…³ç³»

```typescript
async function createDocument(authorId: string, data: DocumentData) {
  // 1. åˆ›å»ºæ–‡æ¡£
  const document = await prisma.document.create({
    data: {
      ...data,
      authorId
    }
  })
  
  // 2. è‡ªåŠ¨åˆ›å»ºæ‹¥æœ‰è€…åä½œå…³ç³»
  await prisma.documentCollaborator.create({
    data: {
      userId: authorId,
      documentId: document.id,
      role: 'OWNER'
    }
  })
  
  return document
}
```

### 2. é‚€è¯·åä½œè€…

```typescript
async function inviteCollaborator(
  documentId: string, 
  inviterId: string, 
  inviteeId: string, 
  role: 'EDITOR' | 'VIEWER'
) {
  // 1. éªŒè¯é‚€è¯·è€…æƒé™
  const inviterCollab = await prisma.documentCollaborator.findFirst({
    where: {
      documentId,
      userId: inviterId,
      role: 'OWNER'  // åªæœ‰æ‹¥æœ‰è€…å¯ä»¥é‚€è¯·
    }
  })
  
  if (!inviterCollab) {
    throw new Error('æ— æƒé™é‚€è¯·åä½œè€…')
  }
  
  // 2. åˆ›å»ºåä½œå…³ç³»
  return await prisma.documentCollaborator.create({
    data: {
      userId: inviteeId,
      documentId,
      role
    }
  })
}
```

### 3. æƒé™æ£€æŸ¥å‡½æ•°

```typescript
// æ£€æŸ¥ç¼–è¾‘æƒé™
async function canEditDocument(userId: string, documentId: string): Promise<boolean> {
  const collaboration = await prisma.documentCollaborator.findFirst({
    where: {
      userId,
      documentId,
      role: { in: ['OWNER', 'EDITOR'] }
    }
  })
  
  return !!collaboration
}

// æ£€æŸ¥æŸ¥çœ‹æƒé™  
async function canViewDocument(userId: string, documentId: string): Promise<boolean> {
  // 1. æ£€æŸ¥æ˜¯å¦æœ‰åä½œæƒé™
  const collaboration = await prisma.documentCollaborator.findFirst({
    where: { userId, documentId }
  })
  
  if (collaboration) return true
  
  // 2. æ£€æŸ¥æ˜¯å¦ä¸ºå…¬å¼€æ–‡æ¡£
  const document = await prisma.document.findFirst({
    where: { id: documentId, isPublic: true }
  })
  
  return !!document
}

// æ£€æŸ¥ç®¡ç†æƒé™
async function canManageDocument(userId: string, documentId: string): Promise<boolean> {
  const collaboration = await prisma.documentCollaborator.findFirst({
    where: {
      userId,
      documentId,
      role: 'OWNER'
    }
  })
  
  return !!collaboration
}
```

## ğŸ” å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼

### 1. è·å–ç”¨æˆ·å¯è®¿é—®çš„æ‰€æœ‰æ–‡æ¡£

```typescript
async function getUserAccessibleDocuments(userId: string) {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    include: {
      collaborations: {
        include: {
          document: {
            include: {
              author: { select: { id: true, name: true } },
              _count: { select: { collaborators: true } }
            }
          }
        }
      }
    }
  })
  
  // è¿”å›ç”¨æˆ·æœ‰æƒé™è®¿é—®çš„æ‰€æœ‰æ–‡æ¡£
  return user?.collaborations.map(collab => ({
    ...collab.document,
    myRole: collab.role
  })) || []
}
```

### 2. è·å–æ–‡æ¡£çš„æ‰€æœ‰åä½œè€…

```typescript
async function getDocumentCollaborators(documentId: string) {
  return await prisma.documentCollaborator.findMany({
    where: { documentId },
    include: {
      user: {
        select: { id: true, name: true, email: true, avatar: true }
      }
    },
    orderBy: [
      { role: 'asc' },  // OWNER ä¼˜å…ˆ
      { createdAt: 'asc' }
    ]
  })
}
```

### 3. æ£€æŸ¥ç”¨æˆ·åœ¨ç‰¹å®šæ–‡æ¡£ä¸­çš„è§’è‰²

```typescript
async function getUserRoleInDocument(userId: string, documentId: string) {
  const collaboration = await prisma.documentCollaborator.findFirst({
    where: { userId, documentId },
    select: { role: true }
  })
  
  return collaboration?.role || null
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ç´¢å¼•

```sql
-- åä½œå…³ç³»æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_collaborator_user_doc ON document_collaborators(userId, documentId);
CREATE INDEX idx_collaborator_doc ON document_collaborators(documentId);
CREATE INDEX idx_collaborator_user ON document_collaborators(userId);

-- æ–‡æ¡£æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_document_author ON documents(authorId);
CREATE INDEX idx_document_public ON documents(isPublic);
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```typescript
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ include å‡å°‘æŸ¥è¯¢æ¬¡æ•°
const userWithDocs = await prisma.user.findUnique({
  where: { id: userId },
  include: {
    collaborations: {
      include: { document: true }
    }
  }
})

// âŒ é¿å…ï¼šN+1 æŸ¥è¯¢é—®é¢˜
const collaborations = await prisma.documentCollaborator.findMany({
  where: { userId }
})
for (const collab of collaborations) {
  const document = await prisma.document.findUnique({
    where: { id: collab.documentId }
  })
}
```

## ğŸš¨ æ³¨æ„äº‹é¡¹å’Œé™åˆ¶

### 1. æ•°æ®ä¸€è‡´æ€§

- **æ–‡æ¡£ä½œè€…å¿…é¡»æ˜¯ OWNER**ï¼šç¡®ä¿ `Document.authorId` å¯¹åº”çš„ç”¨æˆ·åœ¨ `DocumentCollaborator` ä¸­æœ‰ OWNER è§’è‰²
- **å”¯ä¸€æ€§çº¦æŸ**ï¼šä¸€ä¸ªç”¨æˆ·åœ¨ä¸€ä¸ªæ–‡æ¡£ä¸­åªèƒ½æœ‰ä¸€ä¸ªè§’è‰²
- **çº§è”åˆ é™¤**ï¼šåˆ é™¤ç”¨æˆ·æˆ–æ–‡æ¡£æ—¶ï¼Œç›¸å…³çš„åä½œå…³ç³»ä¼šè‡ªåŠ¨åˆ é™¤

### 2. ä¸šåŠ¡è§„åˆ™

- **è‡³å°‘ä¸€ä¸ª OWNER**ï¼šæ¯ä¸ªæ–‡æ¡£å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ª OWNER
- **OWNER æƒé™**ï¼šåªæœ‰ OWNER å¯ä»¥åˆ é™¤æ–‡æ¡£æˆ–ç®¡ç†å…¶ä»–åä½œè€…
- **è§’è‰²å˜æ›´**ï¼šå¯ä»¥æ›´æ”¹åä½œè€…è§’è‰²ï¼Œä½†ä¸èƒ½ç§»é™¤æœ€åä¸€ä¸ª OWNER

### 3. æ‰©å±•æ€§è€ƒè™‘

å½“å‰è®¾è®¡æ”¯æŒæœªæ¥æ‰©å±•ï¼š
- **å›¢é˜Ÿæƒé™**ï¼šå¯ä»¥æ·»åŠ  Team æ¨¡å‹ï¼Œå®ç°åŸºäºå›¢é˜Ÿçš„æƒé™ç®¡ç†
- **ç»†ç²’åº¦æƒé™**ï¼šå¯ä»¥æ‰©å±•è§’è‰²ç³»ç»Ÿï¼Œæ·»åŠ æ›´å¤šæƒé™ç²’åº¦
- **æƒé™ç»§æ‰¿**ï¼šå¯ä»¥å®ç°æ–‡æ¡£å¤¹çº§åˆ«çš„æƒé™ç»§æ‰¿

## ğŸ“ æ€»ç»“

åä½œå…³ç³»è®¾è®¡çš„æ ¸å¿ƒæ€æƒ³ï¼š
1. **æ¸…æ™°çš„è§’è‰²æƒé™**ï¼šOWNER/EDITOR/VIEWER ä¸‰çº§æƒé™ä½“ç³»
2. **çµæ´»çš„å¤šå¯¹å¤šå…³ç³»**ï¼šé€šè¿‡ä¸­é—´è¡¨å®ç°å¤æ‚çš„åä½œåœºæ™¯
3. **æ•°æ®ä¸€è‡´æ€§ä¿è¯**ï¼šé€šè¿‡çº¦æŸå’Œçº§è”åˆ é™¤ç¡®ä¿æ•°æ®å®Œæ•´æ€§
4. **é«˜æ•ˆçš„æŸ¥è¯¢æ¨¡å¼**ï¼šä¼˜åŒ–çš„ç´¢å¼•å’ŒæŸ¥è¯¢ç­–ç•¥
5. **è‰¯å¥½çš„æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

è¿™ç§è®¾è®¡èƒ½å¤Ÿæ»¡è¶³å¤§å¤šæ•°åä½œæ–‡æ¡£ç³»ç»Ÿçš„éœ€æ±‚ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„ç®€æ´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ 