# 第二阶段任务清单 - 前端界面开发 (标签页设计)

## 总体目标

基于第一阶段已完成的数据持久化系统，开发现代化的标签页文档管理界面，实现类似 VS Code 和 Notion 的专业文档工作体验。采用侧边栏文档导航 + 标签页多文档编辑的布局模式。

## 🔗 任务依赖关系和优先级分析

### 📊 依赖关系图

```
阶段 2.1 基础架构 (🔴 必须最先)
    ↓
┌─ 阶段 2.2 标签页系统 (🔴 核心) ←──┐
│   ↓                              │
├─ 阶段 2.3 侧边栏导航 (🔴 核心) ←──┤ (可并行)
│   ↓                              │
└─ 阶段 2.4 编辑器增强 (🟡 增强) ←──┘
    ↓
┌─ 阶段 2.5 响应式设计 (🟡 优化) ←─ (可并行)
├─ 阶段 2.6 系统状态 (🟢 润色) ←─┘
```

### 🎯 关键路径分析

#### **第一轮开发 (MVP核心功能)** - 必须顺序执行
1. **阶段 2.1** → **阶段 2.2** → **阶段 2.3** 
   - 总时间：11 + 21 + 13 = **45小时**
   - 依赖关系：严格顺序，无法并行
   - 产出：基本可用的标签页文档管理系统

#### **第二轮开发 (功能增强)** - 可部分并行
2. **阶段 2.4** 基于前面三个阶段
   - 时间：15小时
   - 产出：完整的编辑体验

#### **第三轮开发 (体验优化)** - 可完全并行
3. **阶段 2.5** + **阶段 2.6** 可同时进行
   - 时间：max(12, 7) = 12小时
   - 产出：生产就绪的应用

### ⚡ 优化执行策略

#### **策略一：顺序开发 (稳妥)**
- 总时间：79小时 (3-4周)
- 风险：低
- 适合：单人开发

#### **策略二：MVP优先 (推荐)**
- 第一阶段：45小时 → 可用MVP
- 第二阶段：15小时 → 完整功能 
- 第三阶段：12小时 → 优化体验
- 优势：快速验证，渐进式开发

#### **策略三：并行开发 (高效)**
- 前提：有多个开发者
- 2.5和2.6可在2.4完成后并行
- 节省时间：7小时

### 🚨 关键依赖点

1. **基础架构 (2.1) → 所有后续阶段**
   - 状态管理架构必须先完成
   - 布局系统是UI的基础

2. **标签页系统 (2.2) → 侧边栏导航 (2.3)**
   - 侧边栏需要调用标签页的打开方法
   - 标签页状态需要与文档列表同步

3. **标签页+侧边栏 (2.2+2.3) → 编辑器增强 (2.4)**
   - 编辑器需要集成到标签页容器中
   - 文档头部需要标签页状态信息

4. **核心功能 (2.1-2.4) → 优化阶段 (2.5+2.6)**
   - 响应式设计需要基于完整功能
   - 性能优化需要完整系统运行

## 🎯 核心目标

1. **标签页多文档系统** - VS Code 风格的标签页，支持同时编辑多个文档
2. **侧边栏文档导航** - 统一的文档浏览和管理入口 
3. **专业编辑体验** - 每个标签页独立的协作编辑器和状态
4. **合理使用组件库** - shadcn/ui 仅在合适场景使用，其余用 Tailwind 原子类
5. **高性能多实例管理** - 内存优化的多文档实例系统

## 🏗️ 最终布局架构

```
┌─────────────────────────────────────────────────────────────┐
│  Header (Button组件 + Tailwind布局)                        │
├─────────────┬───────────────────────────────────────────────┤
│  Sidebar    │  Main Content Area                            │
│  (Sidebar)  │  ┌─────────────────────────────────────────┐  │
│  ┌─────────┐│  │ Tabs Bar (Tailwind + Button)           │  │
│  │Input    ││  │ [Doc1] [Doc2*] [Doc3] [+] [×] [⋯]      │  │
│  │搜索     ││  ├─────────────────────────────────────────┤  │
│  ├─────────┤│  │ Document Header (Input + Tailwind)     │  │
│  │简单列表  ││  │ ┌─────────────────┬─────────────────────┐│  │
│  │ Doc 1   ││  │ │ 标题编辑        │ Avatar + Tooltip    ││  │
│  │ Doc 2 * ││  │ │ 操作按钮        │ 在线状态            ││  │
│  │ Doc 3   ││  │ └─────────────────┴─────────────────────┘│  │
│  │...      ││  ├─────────────────────────────────────────┤  │
│  │Button   ││  │                                         │  │
│  │+ New    ││  │        Tiptap Editor                    │  │
│  └─────────┘│  │                                         │  │
│             │  │        (保持现有实现)                    │  │
│             │  │                                         │  │
│             │  └─────────────────────────────────────────┘  │
├─────────────┴───────────────────────────────────────────────┤
│  Footer: Tailwind布局 + Badge(状态)                        │
└─────────────────────────────────────────────────────────────┘
```

**组件使用策略：**
- **✅ 使用 shadcn/ui**: Button, Input, Badge, Tooltip, Dialog, DropdownMenu, Sidebar
- **❌ 避免过度使用**: Card(文档项), Progress(简单状态), Alert(简单提示)
- **🎯 Tailwind 实现**: 布局、列表项、简单状态、基础样式

## 任务分解

### 🚀 阶段 2.1：基础架构和布局 (优先级：🔴 最高)

#### 任务 2.1.1：整体布局架构设计
- [ ] 基于 shadcn/ui Sidebar 组件设计主布局
- [ ] 保持 Tailwind 最小配置原则
- [ ] 合理选择组件 vs 原子类
- [ ] 安装少量必需的 shadcn/ui 组件

**预计时间：** 5小时  
**技术要点：**
- 主布局使用 Tailwind Grid: `h-screen grid grid-rows-[auto_1fr_auto]`
- 仅在复杂交互场景使用 shadcn/ui 组件
- 文档列表用简单的 div + hover 效果
- 避免为了一致性而强行使用组件

**需要安装的 shadcn/ui 组件 (最小化)：**
```bash
# 仅安装真正需要的复杂组件
npx shadcn@latest add dropdown-menu  # 操作菜单
npx shadcn@latest add dialog         # 创建/删除确认
npx shadcn@latest add tooltip        # 悬停信息
npx shadcn@latest add badge          # 状态指示
npx shadcn@latest add avatar         # 用户头像
npx shadcn@latest add command        # Cmd+P 搜索

# 不需要：tabs(自定义实现), card(过重), alert(用toast), progress(简单实现)
```

**输出文件：**
```
src/app/documents/layout.tsx    # Tailwind Grid + Sidebar组件
src/components/layout/
├── app-header.tsx              # Tailwind flex + Button
├── app-sidebar.tsx             # shadcn/ui Sidebar + 简单列表
├── main-content.tsx            # Tailwind Grid 布局
├── app-footer.tsx              # Tailwind flex + Badge
└── responsive-layout.tsx       # Tailwind 媒体查询
```

#### 任务 2.1.2：状态管理架构搭建
- [ ] 安装和配置 TanStack Query + Zustand
- [ ] 设计标签页状态管理架构
- [ ] 创建多文档实例管理系统
- [ ] 实现临时认证和API客户端

**预计时间：** 6小时  
**技术栈：**
```bash
npm install @tanstack/react-query zustand
npm install @tanstack/react-query-devtools
npm install react-hotkeys-hook  # 键盘快捷键
```

**输出文件：**
```
src/lib/
├── api-client.ts              # API 客户端封装
├── query-client.ts            # TanStack Query 配置
└── stores/
    ├── tab-store.ts           # 标签页状态管理
    ├── sidebar-store.ts       # 侧边栏状态管理
    ├── document-instances.ts  # 多文档实例管理
    └── ui-store.ts            # UI 状态管理

src/hooks/
├── use-temp-auth.ts           # 临时认证 Hook
├── use-tabs.ts                # 标签页操作 Hook
├── use-documents.ts           # 文档数据 Hook
├── use-hotkeys.ts             # 快捷键 Hook
└── use-api.ts                 # API 调用 Hook
```

**🎉 阶段 2.1 成功标准：**
- [ ] 响应式布局系统正常工作
- [ ] 状态管理架构搭建完成
- [ ] API 客户端能调用现有接口
- [ ] 临时认证方案运行正常

---

### 📑 阶段 2.2：标签页系统核心 (优先级：🔴 最高)

#### 任务 2.2.1：标签页基础系统
- [ ] 自定义标签页实现 (Tailwind + 简单状态)
- [ ] 避免 shadcn/ui Tabs (不够灵活)
- [ ] 标签页状态管理逻辑
- [ ] 基础操作 (打开、关闭、切换)

**预计时间：** 8小时  
**实现方案：**
- 标签栏：Tailwind flex + 横向滚动
- 标签项：简单 button + active 状态样式
- 关闭按钮：Button 组件 size="sm" variant="ghost"
- 脏状态：简单的 `::before` 伪元素小圆点

**输出文件：**
```
src/components/tabs/
├── tab-bar.tsx                # Tailwind flex 实现
├── tab-item.tsx               # 简单 button + 状态类
├── tab-content.tsx            # 简单容器
├── tab-controls.tsx           # Button 组件
└── tab-overflow.tsx           # DropdownMenu 组件

src/lib/tabs/
├── tab-manager.ts             # 状态管理
├── tab-utils.ts               # 工具函数
└── tab-types.ts               # 类型定义
```

#### 任务 2.2.2：标签页高级功能
- [ ] 右键菜单 (DropdownMenu 组件)
- [ ] 未保存状态 (Tailwind 伪元素)
- [ ] 拖拽排序 (与 Tailwind 样式配合)
- [ ] 标签页持久化

**预计时间：** 6小时  
**技术选择：**
- 右键菜单：shadcn/ui DropdownMenu (复杂交互，值得用组件)
- 脏状态指示：Tailwind `before:` 伪类 (简单样式，不需要 Badge)
- 拖拽反馈：Tailwind 过渡类 + 简单样式
- 确认对话框：Dialog 组件 (复杂交互)

**输出文件：**
```
src/components/tabs/
├── tab-context-menu.tsx       # DropdownMenu 实现
├── tab-dirty-indicator.tsx    # Tailwind 伪元素
├── tab-drag-layer.tsx         # Tailwind 过渡
└── tab-session-manager.tsx    # 会话恢复
```

#### 任务 2.2.3：多文档实例管理
- [ ] 文档编辑器实例池
- [ ] 协作连接实例管理
- [ ] 内存优化策略
- [ ] 实例生命周期管理

**预计时间：** 7小时  
**实例管理：**
- Editor实例创建和销毁
- HocuspocusProvider连接池
- 非活跃标签页暂停机制
- 内存泄漏预防

**输出文件：**
```
src/lib/instances/
├── document-instance-manager.ts # 文档实例管理器
├── editor-pool.ts               # 编辑器实例池
├── connection-pool.ts           # 连接池管理
├── memory-optimizer.ts          # 内存优化器
└── instance-types.ts            # 实例类型定义

src/components/editor/
├── tabbed-editor.tsx            # 标签页编辑器容器
├── editor-instance.tsx          # 单个编辑器实例
└── editor-placeholder.tsx       # 编辑器占位符
```

**🎉 阶段 2.2 成功标准：**
- [ ] 可以打开多个文档标签页
- [ ] 标签页之间切换流畅
- [ ] 拖拽排序功能正常
- [ ] 内存使用优化有效
- [ ] URL和标签页状态同步

---

### 📂 阶段 2.3：侧边栏文档导航 (优先级：🔴 最高)

#### 任务 2.3.1：文档列表侧边栏
- [ ] 基于 shadcn/ui Sidebar 基础结构
- [ ] 文档搜索 (Input 组件)
- [ ] 文档列表 (Tailwind 简单列表，非 Card)
- [ ] 新建按钮 (Button + Dialog)

**预计时间：** 6小时  
**实现策略：**
- Sidebar 组件：复杂布局，值得使用
- 搜索框：Input 组件 (表单组件，应该用)
- 文档项：简单 div + hover 效果 (类似 VS Code 文件列表)
- 新建对话框：Dialog 组件 (复杂交互)

**文档项设计 (VS Code 风格)：**
```tsx
// ✅ 简单高效的文档项
function DocumentItem({ doc, isActive, onClick }) {
  return (
    <button
      className={cn(
        "w-full px-3 py-2 text-left text-sm rounded-md transition-colors",
        "hover:bg-accent hover:text-accent-foreground",
        isActive && "bg-accent text-accent-foreground"
      )}
      onClick={onClick}
    >
      <div className="flex items-center gap-2">
        <FileIcon className="h-4 w-4" />
        <span className="truncate">{doc.title}</span>
        {doc.isDirty && (
          <div className="h-2 w-2 bg-orange-500 rounded-full" />
        )}
      </div>
    </button>
  )
}

// ❌ 过度使用 Card
function DocumentCard({ doc }) {
  return (
    <Card className="p-3">  {/* 太重了，不必要的边框和阴影 */}
      <CardContent>         {/* 额外的层级 */}
        ...
      </CardContent>
    </Card>
  )
}
```

**输出文件：**
```
src/components/sidebar/
├── documents-sidebar.tsx       # Sidebar + Tailwind 布局
├── document-search.tsx         # Input 组件
├── document-list.tsx           # Tailwind 简单列表
├── document-item.tsx           # Tailwind button 实现
├── new-document-button.tsx     # Button 组件
└── new-document-dialog.tsx     # Dialog 组件
```

#### 任务 2.3.2：文档筛选和排序
- [ ] 筛选按钮 (Button + 简单 Popover)
- [ ] 排序选择 (DropdownMenu 组件)
- [ ] 收藏功能 (简单 button + star icon)
- [ ] 最近访问 (Tailwind 分组)

**预计时间：** 4小时  
**简化方案：**
- 筛选：简单的 Button + 内联状态 (不需要复杂的 Popover)
- 排序：DropdownMenu (多选项，值得用组件)
- 收藏：Tailwind 样式的星标按钮
- 分组：Tailwind text 标题 + 简单分割

**输出文件：**
```
src/components/sidebar/
├── filter-toggle.tsx           # 简单 Button 切换
├── sort-dropdown.tsx           # DropdownMenu
├── favorites-section.tsx       # Tailwind 分组
└── recent-section.tsx          # Tailwind 分组
```

#### 任务 2.3.3：侧边栏状态管理
- [ ] 侧边栏展开/收缩状态
- [ ] 搜索状态管理
- [ ] 筛选状态持久化
- [ ] 选中文档高亮

**预计时间：** 3小时  
**状态管理：**
- 侧边栏宽度调整
- 搜索历史记录
- 筛选条件保存
- 活跃文档指示

**输出文件：**
```
src/lib/stores/
├── sidebar-store.ts            # 侧边栏状态
├── search-store.ts             # 搜索状态
└── filter-store.ts             # 筛选状态

src/hooks/
├── use-sidebar.ts              # 侧边栏操作
├── use-search.ts               # 搜索功能
└── use-filters.ts              # 筛选功能
```

**🎉 阶段 2.3 成功标准：**
- [ ] 侧边栏显示所有文档列表
- [ ] 搜索和筛选功能正常
- [ ] 点击文档在新标签页打开
- [ ] 侧边栏状态持久化
- [ ] 性能优化 (虚拟滚动)

---

### 🎨 阶段 2.4：文档编辑器增强 (优先级：🟡 中等)

#### 任务 2.4.1：文档头部区域
- [ ] 可编辑标题 (Input 组件)
- [ ] 操作按钮 (Button + DropdownMenu)
- [ ] 协作者头像 (Avatar + Tooltip)  
- [ ] 保存状态 (简单 Badge + Tailwind 动画)

**预计时间：** 5小时  
**组件选择原则：**
- Input: 表单组件，应该用 ✅
- DropdownMenu: 复杂菜单，应该用 ✅  
- Avatar: 复杂样式，应该用 ✅
- Tooltip: 交互组件，应该用 ✅
- 保存状态: 简单文本 + Badge，不需要 Progress 组件

**输出文件：**
```
src/components/document/
├── document-header.tsx         # Tailwind flex 布局
├── editable-title.tsx          # Input 组件
├── document-actions.tsx        # DropdownMenu 组件
├── collaboration-info.tsx      # Avatar + Tooltip
└── save-status.tsx             # 简单 Badge + 文本
```

#### 任务 2.4.2：协作编辑器集成
- [ ] 保持现有 collaborative-editor.tsx
- [ ] 标签页级别的编辑器包装
- [ ] 工具栏 Button 组件化 (仅复杂按钮)
- [ ] 状态反馈 (简单文本 + Badge)

**预计时间：** 6小时  
**集成策略：**
- 现有编辑器：保持不变，已经工作良好
- 工具栏：复杂按钮用 Button 组件，简单的保持原样
- 状态显示：简单文本，不需要复杂的 Alert 组件
- 错误提示：简单的 toast 函数调用

**输出文件：**
```
src/components/editor/
├── collaborative-editor-tab.tsx # 简单包装器
├── editor-toolbar-enhanced.tsx  # 选择性使用 Button
├── collaboration-cursors.tsx    # 保持现有实现
├── online-users-list.tsx        # Avatar 组件
└── editor-status-bar.tsx        # Tailwind + Badge
```

#### 任务 2.4.3：快捷键和用户体验
- [ ] 全局快捷键系统
- [ ] 命令面板 (Command 组件，复杂功能值得用)
- [ ] 快捷键提示 (Tooltip 组件)
- [ ] 简单错误处理 (toast 函数，不用 Alert 组件)

**预计时间：** 4小时  
**UX 组件选择：**
- Command: 复杂的搜索/筛选功能，值得用组件 ✅
- Tooltip: 交互增强，值得用组件 ✅
- Toast: 简单反馈，用函数调用而非组件包装
- 快捷键显示: 简单 kbd 标签 + Tailwind 样式

**输出文件：**
```
src/lib/hotkeys/
├── global-shortcuts.ts         # 快捷键绑定
├── tab-shortcuts.ts            # 标签页快捷键
└── editor-shortcuts.ts         # 编辑器快捷键

src/components/ui/
├── command-palette.tsx         # Command 组件实现
└── shortcut-kbd.tsx            # 简单 kbd 标签
```

**🎉 阶段 2.4 成功标准：**
- [ ] 文档头部信息完整显示
- [ ] 协作编辑器功能完整
- [ ] 快捷键操作流畅
- [ ] 错误处理完善

---

### 📱 阶段 2.5：响应式设计和移动端适配 (优先级：🟡 中等)

#### 任务 2.5.1：响应式布局优化
- [ ] 断点设计和媒体查询
- [ ] 移动端侧边栏 (抽屉模式)
- [ ] 移动端标签页处理
- [ ] 触摸操作适配

**预计时间：** 7小时  
**响应式策略：**
- 桌面端: 固定侧边栏 + 完整标签页
- 平板端: 可收缩侧边栏 + 简化标签页
- 移动端: 抽屉侧边栏 + 底部导航

**输出文件：**
```
src/components/mobile/
├── mobile-sidebar-drawer.tsx   # 移动端抽屉
├── mobile-tab-navigation.tsx   # 移动端标签页导航
├── mobile-document-header.tsx  # 移动端文档头部
└── touch-gestures.tsx          # 触摸手势处理

src/components/responsive/
├── responsive-sidebar.tsx      # 响应式侧边栏
├── responsive-tabs.tsx         # 响应式标签页
└── breakpoint-provider.tsx     # 断点状态提供者 (useMediaQuery hook)
```

#### 任务 2.5.2：移动端编辑体验
- [ ] 移动端编辑器优化
- [ ] 虚拟键盘适配
- [ ] 手势操作支持
- [ ] 移动端工具栏

**预计时间：** 5小时  
**移动端优化：**
- 编辑器触摸操作
- 键盘弹出自适应
- 滑动手势支持
- 简化的工具栏

**输出文件：**
```
src/components/mobile/
├── mobile-editor.tsx           # 移动端编辑器
├── mobile-toolbar.tsx          # 移动端工具栏
├── keyboard-adapter.tsx        # 虚拟键盘适配
└── gesture-handler.tsx         # 手势处理
```

**响应式设计最佳实践：**
```typescript
// hooks/use-responsive.ts - 响应式状态管理
export function useResponsive() {
  const [mounted, setMounted] = useState(false)
  
  // 使用 Tailwind 断点
  const isMobile = useMediaQuery('(max-width: 767px)')    // < md
  const isTablet = useMediaQuery('(min-width: 768px) and (max-width: 1023px)') // md to lg
  const isDesktop = useMediaQuery('(min-width: 1024px)')  // >= lg
  
  useEffect(() => setMounted(true), [])
  
  if (!mounted) return { isMobile: false, isTablet: false, isDesktop: true }
  
  return { isMobile, isTablet, isDesktop }
}

// components/responsive/responsive-sidebar.tsx
function ResponsiveSidebar() {
  const { isMobile } = useResponsive()
  const [isOpen, setIsOpen] = useState(false)
  
  if (isMobile) {
    return (
      <>
        {/* Mobile Drawer */}
        <div className={cn(
          "fixed inset-y-0 left-0 z-50 w-60 bg-sidebar border-r",
          "transform transition-transform duration-300 ease-in-out",
          isOpen ? "translate-x-0" : "-translate-x-full"
        )}>
          <DocumentsSidebar />
        </div>
        
        {/* Overlay */}
        {isOpen && (
          <div 
            className="fixed inset-0 bg-black/50 z-40"
            onClick={() => setIsOpen(false)}
          />
        )}
      </>
    )
  }
  
  // Desktop/Tablet 固定侧边栏
  return (
    <aside className="hidden md:block w-70 bg-sidebar border-r">
      <DocumentsSidebar />
    </aside>
  )
}

// components/responsive/responsive-tabs.tsx  
function ResponsiveTabs() {
  const { isMobile } = useResponsive()
  
  if (isMobile) {
    // 移动端简化为选择器
    return <MobileDocumentSelector />
  }
  
  // 桌面端完整标签页
  return <TabBar />
}
```

**🎉 阶段 2.5 成功标准：**
- [ ] 各种屏幕尺寸正常显示
- [ ] 移动端操作体验良好
- [ ] 标签页在移动端合理降级
- [ ] 触摸交互流畅

---

### 🎨 阶段 2.6：系统状态和优化 (优先级：🟢 较低)

#### 任务 2.6.1：系统状态Footer
- [ ] 连接状态指示器
- [ ] 服务器状态显示
- [ ] API健康监控
- [ ] 管理入口

**预计时间：** 3小时  
**状态显示：**
- 实时连接状态
- Hocuspocus服务器状态
- API响应时间
- 系统管理链接

**输出文件：**
```
src/components/footer/
├── app-footer.tsx              # 应用底栏
├── connection-status.tsx       # 连接状态
├── server-status.tsx           # 服务器状态
├── api-health.tsx              # API健康状态
└── admin-actions.tsx           # 管理操作
```

#### 任务 2.6.2：性能优化和监控
- [ ] 组件懒加载
- [ ] 内存使用监控
- [ ] 性能指标收集
- [ ] 错误上报系统

**预计时间：** 4小时  
**性能优化：**
- React.lazy 懒加载
- 内存泄漏监控
- 性能指标埋点
- Sentry 错误收集

**输出文件：**
```
src/lib/performance/
├── lazy-loading.ts             # 懒加载配置
├── memory-monitor.ts           # 内存监控
├── performance-tracker.ts      # 性能追踪
└── error-reporter.ts           # 错误上报

src/components/monitoring/
├── performance-overlay.tsx     # 性能监控面板
└── memory-usage.tsx            # 内存使用显示
```

**🎉 阶段 2.6 成功标准：**
- [ ] 系统状态一目了然
- [ ] 性能监控正常工作
- [ ] 内存使用优化
- [ ] 错误处理完善

---

## 🔧 技术方案详解

### 标签页状态管理
```typescript
// stores/tab-store.ts
interface TabData {
  id: string
  documentId: string
  title: string
  isDirty: boolean
  isActive: boolean
  isPinned: boolean
  lastModified: Date
  saveStatus: 'saved' | 'saving' | 'error'
  collaborators: User[]
}

interface TabStore {
  tabs: TabData[]
  activeTabId: string | null
  maxTabs: number

  // 核心操作
  openTab: (documentId: string) => void
  closeTab: (tabId: string) => void
  switchTab: (tabId: string) => void
  moveTab: (fromIndex: number, toIndex: number) => void
  
  // 批量操作
  closeOtherTabs: (keepTabId: string) => void
  closeAllTabs: () => void
  closeTabsToRight: (tabId: string) => void
  
  // 状态查询
  getActiveTab: () => TabData | null
  getTabById: (tabId: string) => TabData | null
  isDirty: (tabId: string) => boolean
  canCloseTab: (tabId: string) => boolean
}
```

### 多文档实例管理
```typescript
// lib/instances/document-instance-manager.ts
interface DocumentInstance {
  id: string
  documentId: string
  editor: Editor
  provider: HocuspocusProvider
  isActive: boolean
  lastActivity: Date
  saveStatus: SaveStatus
}

class DocumentInstanceManager {
  private instances = new Map<string, DocumentInstance>()
  private readonly MAX_INSTANCES = 10

  async createInstance(documentId: string): Promise<DocumentInstance> {
    // 创建编辑器实例
    // 建立 Hocuspocus 连接
    // 注册到实例池
  }

  destroyInstance(documentId: string): void {
    // 销毁编辑器
    // 断开连接
    // 清理内存
  }

  pauseInstance(documentId: string): void {
    // 暂停非活跃实例以节省资源
  }

  resumeInstance(documentId: string): void {
    // 恢复活跃实例
  }

  cleanupInactive(): void {
    // 清理长时间不活跃的实例
  }
}
```

### 临时认证架构
```typescript
// hooks/use-temp-auth.ts
export function useTempAuth() {
  return {
    user: {
      id: 'demo_user_001',
      name: '演示用户',
      email: 'demo@example.com',
      avatar: '/avatars/demo-user.png',
      color: '#3b82f6'
    },
    isAuthenticated: true,
    login: async () => ({ success: true }),
    logout: async () => ({ success: true })
  }
}
```

### 响应式布局配置
```typescript
// tailwind.config.ts - 最小必要配置
export default {
  theme: {
    extend: {
      // 仅添加真正需要且默认值不支持的
      gridTemplateRows: {
        'app': 'auto 1fr auto', // 这个确实需要，因为默认没有
      },
      // 其他都用默认值！
    }
  }
}

// 布局实现 - 使用默认值和内联类
function AppLayout() {
  return (
    <div className="h-screen grid grid-rows-app">
      {/* Header - 使用默认高度 */}
      <header className="bg-background border-b">...</header>
      
      {/* Main Content - 内联网格模板 */}
      <main className="grid grid-cols-1 md:grid-cols-[280px_1fr] overflow-hidden">
        {/* Sidebar - 使用默认宽度 */}
        <aside className="hidden md:block w-70 bg-sidebar border-r">...</aside>
        
        {/* Content */}
        <section className="grid grid-rows-[auto_1fr] overflow-hidden">
          {/* Tabs - 使用默认高度 */}
          <div className="h-12 bg-muted border-b">...</div>
          
          {/* Editor */}
          <div className="overflow-hidden">...</div>
        </section>
      </main>
      
      {/* Footer - 使用默认高度 */}
      <footer className="bg-muted border-t">...</footer>
    </div>
  )
}
```

### 样式组织策略
```typescript
// lib/layout-utils.ts - 可选的样式常量
export const layoutClasses = {
  // 只定义真正复用的复杂样式组合
  container: "h-screen grid grid-rows-app",
  mainGrid: "grid grid-cols-1 md:grid-cols-[280px_1fr] overflow-hidden",
  contentGrid: "grid grid-rows-[auto_1fr] overflow-hidden",
  
  sidebar: {
    // 使用默认宽度类
    desktop: "hidden md:block w-70 bg-sidebar border-r",
    mobile: "fixed inset-y-0 left-0 z-50 w-60 bg-sidebar border-r transform transition-transform duration-300",
  }
} as const

// 大多数情况下直接内联使用
<div className="h-12 bg-muted border-b flex items-center px-4">
  {/* 简单样式直接内联，无需抽象 */}
</div>
```

### 响应式最佳实践
```typescript
// hooks/use-responsive.ts - 使用默认断点
export function useResponsive() {
  // 直接使用 Tailwind 默认断点值
  const isMobile = useMediaQuery('(max-width: 767px)')    // < md
  const isTablet = useMediaQuery('(min-width: 768px) and (max-width: 1023px)') // md to lg
  const isDesktop = useMediaQuery('(min-width: 1024px)')  // >= lg
  
  return { isMobile, isTablet, isDesktop }
}

// 组件中直接使用默认断点前缀
function ResponsiveSidebar() {
  return (
    <aside className="
      hidden md:block 
      w-60 md:w-70 lg:w-80 
      bg-sidebar border-r
    ">
      <DocumentsSidebar />
    </aside>
  )
}
```

## 📊 时间预估总览

| 阶段 | 任务数 | 预计时间 | 主要内容 |
|------|--------|---------|----------|
| **2.1 基础架构** | 2个任务 | 11小时 | 布局设计、状态管理 |
| **2.2 标签页系统** | 3个任务 | 21小时 | 标签页核心、高级功能、实例管理 |
| **2.3 侧边栏导航** | 3个任务 | 13小时 | 文档列表、筛选、状态管理 |
| **2.4 编辑器增强** | 3个任务 | 15小时 | 文档头部、编辑器集成、快捷键 |
| **2.5 响应式设计** | 2个任务 | 12小时 | 响应式布局、移动端适配 |
| **2.6 系统优化** | 2个任务 | 7小时 | 状态footer、性能优化 |

**总计预估时间：** 79小时 (约 3-4周，每天 4-5小时)

## 🎯 里程碑检查点

### ✅ 检查点 1：基础架构完成
- [ ] 响应式布局系统正常工作
- [ ] 状态管理架构搭建完成
- [ ] API 客户端能调用所有现有接口
- [ ] 临时认证方案运行正常

### ✅ 检查点 2：标签页系统可用
- [ ] 基础标签页功能 (打开、关闭、切换)
- [ ] 标签页高级功能 (拖拽、右键菜单)
- [ ] 多文档实例管理正常
- [ ] 性能优化有效 (内存使用合理)

### ✅ 检查点 3：完整导航体验
- [ ] 侧边栏文档列表功能完整
- [ ] 搜索和筛选功能正常
- [ ] 文档与标签页联动正常
- [ ] 整体导航体验流畅

### ✅ 检查点 4：专业编辑体验
- [ ] 协作编辑器完整集成
- [ ] 文档头部信息完善
- [ ] 快捷键系统正常
- [ ] 协作功能体验良好

### ✅ 检查点 5：生产就绪
- [ ] 各种屏幕尺寸显示正常
- [ ] 移动端体验良好
- [ ] 性能指标达标
- [ ] 错误处理完善

## 🔄 与第三阶段的衔接计划

### 预留认证集成接口
```typescript
// 为后续认证系统预留接口
interface AuthProvider {
  user: User | null
  isAuthenticated: boolean
  login: (provider: string) => Promise<void>
  logout: () => Promise<void>
}

// 当前使用临时实现，第三阶段替换为真实认证
// 标签页状态、文档权限将与认证系统集成
```

### API 兼容性保证
- 前端标签页状态管理保持接口稳定
- 后端 API 在第三阶段添加认证中间件
- 文档权限检查将集成到标签页打开逻辑
- 协作信息将显示真实用户数据

## 💡 优先级说明

### 🎯 MVP分层策略

#### **MVP 1.0 - 核心可用版本** (45小时)
**目标：** 2周内交付基本可用的标签页文档管理系统

- **🔴 P0 - 阻塞级（必须完成）**
  - 阶段 2.1：基础架构和布局
  - 阶段 2.2.1：标签页基础系统
  - 阶段 2.3.1：文档列表侧边栏
  
- **🟠 P1 - 高优先级（强烈建议）**
  - 阶段 2.2.2：标签页高级功能 (拖拽、右键菜单)
  - 阶段 2.3.2：文档筛选和排序
  - 阶段 2.2.3：多文档实例管理 (简化版)

#### **MVP 2.0 - 完整功能版本** (+15小时)
**目标：** 3周内交付专业级编辑体验

- **🟡 P2 - 中优先级（重要功能）**
  - 阶段 2.4.1：文档头部区域
  - 阶段 2.4.2：协作编辑器集成
  - 阶段 2.4.3：快捷键和用户体验
  - 阶段 2.3.3：侧边栏状态管理

#### **MVP 3.0 - 生产就绪版本** (+12小时)
**目标：** 4周内交付可上线产品

- **🟢 P3 - 低优先级（优化改进）**
  - 阶段 2.5：响应式设计和移动端适配
  - 阶段 2.6：系统状态和性能优化

### ⚠️ 风险评估和应对

#### **技术风险 (高)**
1. **多文档实例管理复杂度**
   - 风险：内存泄漏、性能问题
   - 应对：简化MVP版本，先实现基础功能
   - 后备方案：暂时限制同时打开的标签页数量

2. **标签页状态同步**
   - 风险：URL同步、状态一致性问题  
   - 应对：使用成熟的状态管理方案
   - 后备方案：简化URL同步逻辑

#### **用户体验风险 (中)**
3. **响应式适配工作量**
   - 风险：移动端体验不佳
   - 应对：优先桌面端，移动端适配放到P3
   - 后备方案：提供桌面端专用版本

#### **集成风险 (中)**
4. **现有编辑器集成**
   - 风险：与标签页系统集成困难
   - 应对：保持现有编辑器接口，包装适配
   - 后备方案：在iframe中嵌入现有编辑器

### 🚀 推荐执行路径

#### **第1周：搭建基础 (P0)** 
```bash
✅ 2.1 基础架构 (11小时)
✅ 2.2.1 标签页基础 (8小时) 
✅ 2.3.1 侧边栏基础 (6小时)
```
**里程碑：** 可以打开多个文档标签页，基本切换功能

#### **第2周：完善核心 (P1)**
```bash  
✅ 2.2.2 标签页高级功能 (6小时)
✅ 2.2.3 实例管理简化版 (5小时)  
✅ 2.3.2 文档筛选 (4小时)
✅ 2.3.3 侧边栏状态 (3小时)
```
**里程碑：** 完整的标签页+侧边栏文档管理体验

#### **第3周：编辑器集成 (P2)**
```bash
✅ 2.4.1 文档头部 (5小时)
✅ 2.4.2 编辑器集成 (6小时)  
✅ 2.4.3 快捷键系统 (4小时)
```
**里程碑：** 专业级文档编辑体验

#### **第4周：体验优化 (P3)**
```bash
✅ 2.5 响应式设计 (12小时)
✅ 2.6 系统优化 (7小时，可并行)
```
**里程碑：** 生产就绪，支持全设备

### 📋 动态调整建议

1. **每周评估**：根据实际进度调整后续任务优先级
2. **质量门控**：每个MVP版本都要通过基本功能测试
3. **用户反馈**：MVP 1.0完成后收集用户反馈，调整后续开发重点
4. **技术债务**：在P3阶段重点处理前期技术债务

### 🎯 成功标准

#### **MVP 1.0 成功标准**
- [ ] 可以同时打开5个以上文档标签页
- [ ] 标签页切换响应时间 < 200ms
- [ ] 侧边栏文档搜索功能正常
- [ ] 基本的文档CRUD操作可用

#### **MVP 2.0 成功标准**  
- [ ] 协作编辑器完整集成到标签页
- [ ] 快捷键操作流畅 (Cmd+T/W/Tab等)
- [ ] 文档保存状态实时显示
- [ ] 在线协作者信息正确显示

#### **MVP 3.0 成功标准**
- [ ] 移动端基本可用
- [ ] 内存使用 < 100MB (10个文档)
- [ ] 页面加载时间 < 2秒
- [ ] 零已知Bug

## 📝 开发注意事项

### 性能优化要求
- 标签页数量限制 (最多10个)
- 非活跃编辑器实例暂停
- 虚拟滚动处理大量文档
- 内存泄漏预防和监控

### 用户体验要求
- 标签页切换 < 100ms 响应
- 搜索结果 < 200ms 显示
- 拖拽操作流畅无卡顿
- 快捷键响应及时

### 代码质量要求
- 保持 TypeScript 类型安全
- 遵循 ESLint 代码规范
- 组件单一职责原则
- 完善的错误边界处理

### 兼容性考虑
- 现代浏览器 (Chrome 90+, Firefox 90+, Safari 14+)
- 保持现有 API 接口兼容
- 为第三阶段认证集成预留接口

**让我们打造一个真正专业级的文档协作工具！** 🚀 